<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ËÇ•Ê©òË≤ìÁàÜÁ†¥Áéã v3.7 (‰øÆÂæ©Áâà)</title>
    <style>
        /* Âº∑Âà∂ÈéñÂÆöÁï´Èù¢ÔºåÈò≤Ê≠¢Ë™§Ëß∏ */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed; background: #222;
            touch-action: none; -webkit-user-select: none; user-select: none;
            font-family: 'Roboto Mono', monospace; color: white;
            -webkit-tap-highlight-color: transparent;
        }

        /* ‰∏ªÂÆπÂô® (FlexÁΩÆ‰∏≠) */
        #main-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }

        /* HUD */
        #hud { 
            width: 100%; max-width: 600px; padding: 10px; background: #333; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid #555; font-weight: bold; font-size: 0.9rem;
            flex-shrink: 0; z-index: 50;
        }
        .ammo-box { color: #f1c40f; border: 1px solid #f1c40f; padding: 2px 8px; border-radius: 4px; }
        #reload-btn { background: #0984e3; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* ÈÅäÊà≤ËàûÂè∞ (Á¢∫‰øùÊúâÂØ¨È´ò) */
        #stage { 
            position: relative; 
            width: 90vmin; height: 90vmin; /* Ë¶ñÁ™óÊúÄÂ∞èÈÇäÁöÑ 90% */
            max-width: 600px; max-height: 600px; 
            background: #555; border: 4px solid #000; overflow: hidden; margin: 10px 0;
            flex-shrink: 0;
        }
        .cell { position: absolute; width: 6.66%; height: 6.66%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        .wall { background: #333; border: 1px solid #222; box-shadow: inset 0 0 5px #000; }
        .brick { background: #e17055; border: 2px solid #d63031; transition: 0.2s; }
        .door { background: #000; border: 1px dashed #fff; } 
        .key { font-size: 1.5rem; }

        /* ËßíËâ≤ (ÊîπÁî® EmojiÔºå‰∏ç‰æùË≥¥ÂúñÁâá) */
        #player { 
            position: absolute; width: 6.66%; height: 6.66%; z-index: 20; 
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; /* Â§ß‰∏ÄÈªû */
            transition: top 0.1s linear, left 0.1s linear; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .enemy { position: absolute; width: 6.66%; height: 6.66%; z-index: 15; font-size: 1.5rem; text-align: center; transition: top 0.3s linear, left 0.3s linear; }
        .bomb { position: absolute; width: 5%; height: 5%; margin: 0.8%; z-index: 10; background: #2d3436; border-radius: 50%; border: 2px solid #fff; animation: tick 0.5s infinite alternate; }
        .fire { position: absolute; width: 6.66%; height: 6.66%; z-index: 12; background: rgba(255, 200, 0, 0.8); }
        @keyframes tick { from{transform:scale(0.9)} to{transform:scale(1.1)} }

        /* ÊéßÂà∂Âô® */
        #controls { 
            width: 100%; max-width: 500px; height: 160px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; flex-shrink: 0; z-index: 50;
        }
        .dpad { position: relative; width: 140px; height: 140px; }
        .dbtn { 
            position: absolute; width: 50px; height: 50px; 
            background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4); 
            border-radius: 8px; 
        }
        .dbtn:active { background: rgba(255,255,255,0.5); }
        .du { top:0; left:45px; } .dd { bottom:0; left:45px; } 
        .dl { top:45px; left:0; } .dr { top:45px; right:0; }

        .act-btn { 
            width: 90px; height: 90px; border-radius: 50%; 
            background: #d63031; border: 4px solid #fab1a0; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 2.5rem; box-shadow: 0 5px 0 #8c1c1c; 
        }
        .act-btn:active { transform: translateY(5px); box-shadow: none; }

        /* Á≠îÈ°åÂç° */
        #quiz-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; }
        .card { background: white; color: #333; width: 90%; max-width: 450px; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; text-align: center; }
        .word { font-size: 2.2rem; color: #d63031; font-weight: 800; margin: 0; }
        .meta { color: #666; margin: 5px 0 15px 0; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-audio { border: 1px solid #ccc; background: #eee; border-radius: 15px; padding: 2px 10px; font-size: 0.8rem; cursor: pointer; }
        .sent-box { background: #f1f2f6; padding: 12px; border-radius: 8px; text-align: left; margin-bottom: 15px; border-left: 4px solid #0984e3; }
        .sent-en { font-weight: bold; margin-bottom: 5px; font-size: 1rem; }
        .sent-cn { color: #636e72; font-size: 0.9rem; display: none; }
        .opt-btn { width: 100%; padding: 14px; margin: 6px 0; border: 1px solid #ccc; background: #fff; border-radius: 8px; font-size: 1rem; text-align: left; font-weight: bold; cursor: pointer; }
        .opt-btn.correct { background: #00b894; color: white; border-color: #00b894; }
        .opt-btn.wrong { background: #d63031; color: white; border-color: #d63031; }
    </style>
</head>
<body>

    <div id="main-wrapper">
        <div id="hud">
            <span>‚ù§Ô∏è<span id="ui-hp">3</span></span>
            <span>Lv.<span id="ui-lv">1</span></span>
            <span>üîë<span id="ui-key">0</span></span>
            <span class="ammo-box">üí£<span id="ui-ammo">3</span></span>
            <button id="reload-btn" onclick="triggerQuiz()">+ Ë£úÁµ¶</button>
        </div>

        <div id="stage">
            <div id="layer-grid"></div>
            <div id="layer-item"></div>
            <div id="layer-obj"></div>
            <div id="layer-ent"></div>
            <div id="player">üê±</div>
        </div>

        <div id="controls">
            <div class="dpad">
                <div class="dbtn du" ontouchstart="input.u=true; event.preventDefault()" ontouchend="input.u=false"></div>
                <div class="dbtn dd" ontouchstart="input.d=true; event.preventDefault()" ontouchend="input.d=false"></div>
                <div class="dbtn dl" ontouchstart="input.l=true; event.preventDefault()" ontouchend="input.l=false"></div>
                <div class="dbtn dr" ontouchstart="input.r=true; event.preventDefault()" ontouchend="input.r=false"></div>
            </div>
            <div class="act-btn" ontouchstart="placeBomb(); event.preventDefault()">üí£</div>
        </div>
    </div>

    <div id="quiz-layer">
        <div class="card">
            <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">TOEIC CHALLENGE</div>
            <h1 class="word" id="q-w">Word</h1>
            <div class="meta">
                <span id="q-p">/pho/</span> <span id="q-t">n.</span>
                <button class="btn-audio" onclick="speak('word')">üîä ÂñÆÂ≠ó</button>
            </div>
            <div class="sent-box">
                <div class="sent-en" id="q-s">Example sentence.</div>
                <div class="sent-cn" id="q-sc">‰∏≠ÊñáÁøªË≠Ø</div>
                <button class="btn-audio" style="margin-top:5px;" onclick="speak('sent')">üîä Âî∏‰æãÂè•</button>
            </div>
            <div style="text-align:left; font-size:0.9rem; color:#888;">Ë´ãÈÅ∏ÊìáÊ≠£Á¢∫ÊÑèÊÄùÔºö</div>
            <div id="opt-box"></div>
        </div>
    </div>

    <script>
        document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('dblclick', e => e.preventDefault());

        const RAW_DATA = [
            "Agenda|/…ôÀàd íen.d…ô/|n.|Ë≠∞Á®ã|The agenda is attached.|Ë≠∞Á®ãÂ∑≤ÈôÑ‰∏ä„ÄÇ",
            "Budget|/Ààb åd í.…™t/|n.|È†êÁÆó|Stay within the budget.|‰øùÊåÅÂú®È†êÁÆóÂÖß„ÄÇ",
            "Colleague|/Ààk…ëÀê.liÀê…°/|n.|Âêå‰∫ã|He is my colleague.|‰ªñÊòØÊàëÁöÑÂêå‰∫ã„ÄÇ",
            "Deadline|/Ààded.la…™n/|n.|Êà™Ê≠¢ÊúüÈôê|The deadline is 5 PM.|Êà™Ê≠¢ÊúüÈôêÊòØ‰∏ãÂçà‰∫îÈªû„ÄÇ",
            "Executive|/…™…°Ààzek.j…ô.t…™v/|n.|È´òÈöé‰∏ªÁÆ°|The executive approved it.|È´òÁÆ°ÊâπÂáÜ‰∫Ü„ÄÇ",
            "Feedback|/ÀàfiÀêd.b√¶k/|n.|ÂõûÈ•ã|We value your feedback.|ÊàëÂÄëÈáçË¶ñÊÇ®ÁöÑÂõûÈ•ã„ÄÇ",
            "Guarantee|/Àå…°√¶r.…ônÀàtiÀê/|v.|‰øùË≠â|Satisfaction guaranteed.|‰øùË≠âÊªøÊÑè„ÄÇ",
            "Implement|/Àà…™m.pl…ô.ment/|v.|ÂØ¶ÊñΩ|Implement the plan.|ÂØ¶ÊñΩÈÄôÈ†ÖË®àÁï´„ÄÇ",
            "Lucrative|/ÀàluÀê.kr…ô.t…™v/|adj.|Ë≥∫Èå¢ÁöÑ|A lucrative deal.|‰∏ÄÁ≠ÜË≥∫Èå¢ÁöÑ‰∫§Êòì„ÄÇ",
            "Merger|/Ààm…ùÀê.d í…ö/|n.|Âêà‰Ωµ|The merger is final.|Âêà‰ΩµÊ°àÂ∑≤ÂÆöÊ°à„ÄÇ"
        ];

        const DB = RAW_DATA.map(l => { const p = l.split('|'); return { w:p[0], pho:p[1], t:p[2], m:p[3], s:p[4], sc:p[5] }});
        
        const GRID = 15, TILE = 6.666;
        const STATE = { lv:1, hp:3, key:0, pause:false, bombs:1, range:2, ammo:3 };
        let map=[], enemies=[], bombs=[], player={gx:1,gy:1}, curBomb=null, curQ=null;
        const input = {u:false,d:false,l:false,r:false};

        const dom = {
            grid: document.getElementById('layer-grid'),
            item: document.getElementById('layer-item'),
            obj: document.getElementById('layer-obj'),
            ent: document.getElementById('layer-ent'),
            player: document.getElementById('player'),
            quiz: document.getElementById('quiz-layer'),
            hud: { hp: document.getElementById('ui-hp'), lv: document.getElementById('ui-lv'), key: document.getElementById('ui-key'), ammo: document.getElementById('ui-ammo') },
            q: { w: document.getElementById('q-w'), p: document.getElementById('q-p'), t: document.getElementById('q-t'), s: document.getElementById('q-s'), sc: document.getElementById('q-sc'), box: document.getElementById('opt-box') }
        };

        function init() {
            startLevel(1);
            loop();
        }

        function startLevel(lv) {
            STATE.lv = lv; STATE.key = 0; STATE.pause = false;
            STATE.range = 2 + Math.floor(lv/3);
            
            dom.grid.innerHTML=''; dom.item.innerHTML=''; dom.obj.innerHTML=''; dom.ent.innerHTML='';
            bombs=[]; enemies=[]; map=[];

            for(let y=0; y<GRID; y++) {
                let row = [];
                for(let x=0; x<GRID; x++) {
                    const el=document.createElement('div'); el.className='cell';
                    el.style.left=(x*TILE)+'%'; el.style.top=(y*TILE)+'%'; el.id=`c-${x}-${y}`;
                    if(x===0||x===GRID-1||y===0||y===GRID-1||(x%2===0&&y%2===0)) { row.push(1); el.classList.add('wall'); }
                    else if(x<3&&y<3) { row.push(0); }
                    else { if(Math.random()<0.3) { row.push(2); el.classList.add('brick'); } else row.push(0); }
                    dom.grid.appendChild(el);
                }
                map.push(row);
            }

            let bricks=[]; for(let y=0; y<GRID; y++) for(let x=0; x<GRID; x++) if(map[y][x]===2) bricks.push({x,y});
            if(bricks.length>2) {
                let k=bricks.splice(Math.floor(Math.random()*bricks.length),1)[0]; map[k.y][k.x]=-4;
                let d=bricks.splice(Math.floor(Math.random()*bricks.length),1)[0]; map[d.y][d.x]=-3;
            }

            const count=2+Math.floor(lv/2);
            for(let i=0; i<count; i++) {
                let x,y; do{x=Math.floor(Math.random()*GRID); y=Math.floor(Math.random()*GRID);} while(map[y][x]!==0 || (x<5&&y<5));
                const el=document.createElement('div'); el.className='enemy'; el.innerText=['ü¶†','üëø','üëª'][i%3];
                dom.ent.appendChild(el);
                enemies.push({x,y,el,timer:0,speed:Math.max(10,40-lv*2)});
            }
            updateHUD(); player.gx=1; player.gy=1; updatePlayer();
        }

        function loop() {
            if(!STATE.pause) { movePlayer(); moveEnemies(); updateBombs(); }
            requestAnimationFrame(loop);
        }

        let cd=0;
        function movePlayer() {
            if(cd>0) {cd--; return;}
            let dx=0,dy=0;
            if(input.u) dy=-1; else if(input.d) dy=1; else if(input.l) dx=-1; else if(input.r) dx=1;
            if(dx||dy) {
                let nx=player.gx+dx, ny=player.gy+dy;
                if(nx<0||nx>=GRID||ny<0||ny>=GRID) return;
                let cell=map[ny][nx];
                let bomb=bombs.find(b=>b.x===nx && b.y===ny && !b.pass);
                if((cell<=0||cell===3||cell===4) && !bomb) {
                    player.gx=nx; player.gy=ny; updatePlayer(); checkItem(); cd=6; // ÁßªÂãïÈÄüÂ∫¶Ë™øÊï¥
                    bombs.forEach(b=>{if(b.x!==player.gx||b.y!==player.gy) b.pass=false;});
                }
            }
        }
        function updatePlayer() { dom.player.style.left=(player.gx*TILE)+'%'; dom.player.style.top=(player.gy*TILE)+'%'; }

        function moveEnemies() {
            enemies.forEach(e=>{
                if(e.x===player.gx && e.y===player.gy) hitPlayer();
                if(e.timer>0) {e.timer--; return;}
                e.timer=e.speed;
                const dirs=[[0,1],[0,-1],[1,0],[-1,0]];
                let moved=false, tries=0;
                while(!moved && tries<4) {
                    let d=dirs[Math.floor(Math.random()*4)];
                    let nx=e.x+d[0], ny=e.y+d[1];
                    if(nx>=0&&nx<GRID&&ny>=0&&ny<GRID) {
                        if(map[ny][nx]<=0 && !bombs.find(b=>b.x===nx&&b.y===ny)) {
                            e.x=nx; e.y=ny; e.el.style.left=(e.x*TILE)+'%'; e.el.style.top=(e.y*TILE)+'%'; moved=true;
                        }
                    }
                    tries++;
                }
                if(e.x===player.gx && e.y===player.gy) hitPlayer();
            });
        }
        function hitPlayer() { STATE.hp--; updateHUD(); if(STATE.hp<=0) { alert('Game Over!'); startLevel(STATE.lv); STATE.hp=3; updateHUD(); } }

        function checkItem() {
            let c=map[player.gy][player.gx];
            if(c===4) { STATE.key=1; map[player.gy][player.gx]=0; document.getElementById(`item-${player.gx}-${player.gy}`).remove(); updateHUD(); }
            else if(c===3 && STATE.key) { alert('Level Up!'); startLevel(STATE.lv+1); }
        }

        function placeBomb() {
            if(STATE.pause) return;
            if(STATE.ammo<=0) { let b=document.getElementById('reload-btn'); b.style.background='red'; setTimeout(()=>b.style.background='#0984e3',200); return; }
            if(bombs.find(b=>b.x===player.gx && b.y===player.gy)) return;
            STATE.ammo--; updateHUD();
            const el=document.createElement('div'); el.className='bomb';
            el.style.left=(player.gx*TILE)+'%'; el.style.top=(player.gy*TILE)+'%';
            dom.obj.appendChild(el);
            bombs.push({x:player.gx, y:player.gy, el:el, tick:180, pass:true});
        }

        function updateBombs() {
            for(let i=bombs.length-1; i>=0; i--) {
                let b=bombs[i]; if(!STATE.pause) b.tick--;
                if(b.tick<=0) { explode(b); bombs.splice(i,1); }
            }
        }

        function explode(b) {
            b.el.remove();
            let hits=[{x:b.x, y:b.y}];
            [[0,1],[0,-1],[1,0],[-1,0]].forEach(d=>{
                for(let i=1; i<=STATE.range; i++) {
                    let nx=b.x+d[0]*i, ny=b.y+d[1]*i;
                    if(nx<0||nx>=GRID||ny<0||ny>=GRID) break;
                    if(map[ny][nx]===1) break;
                    hits.push({x:nx, y:ny});
                    if(map[ny][nx]===2 || map[ny][nx]<0) { breakBrick(nx,ny); break; }
                }
            });
            hits.forEach(h=>{
                const f=document.createElement('div'); f.className='fire';
                f.style.left=(h.x*TILE)+'%'; f.style.top=(h.y*TILE)+'%';
                dom.obj.appendChild(f); setTimeout(()=>f.remove(), 500);
                if(player.gx===h.x && player.gy===h.y) hitPlayer();
                for(let i=enemies.length-1; i>=0; i--) { if(enemies[i].x===h.x && enemies[i].y===h.y) { enemies[i].el.remove(); enemies.splice(i,1); }}
            });
        }

        function breakBrick(x,y) {
            const el=document.getElementById(`c-${x}-${y}`); el.className='cell';
            if(map[y][x]===-4) { map[y][x]=4; const i=document.createElement('div'); i.className='cell key'; i.innerText='üîë'; i.id=`item-${x}-${y}`; i.style.left=(x*TILE)+'%'; i.style.top=(y*TILE)+'%'; dom.item.appendChild(i); }
            else if(map[y][x]===-3) { map[y][x]=3; el.classList.add('door'); el.innerText='üö™'; }
            else map[y][x]=0;
        }

        function triggerQuiz() {
            STATE.pause=true; dom.quiz.style.display='flex';
            const q = DB[Math.floor(Math.random()*DB.length)]; curQ=q;
            dom.q.w.innerText=q.w; dom.q.p.innerText=q.pho; dom.q.t.innerText=q.t; dom.q.s.innerText=q.s; dom.q.sc.style.display='none';
            let opts=[q.m]; while(opts.length<4) { let r=DB[Math.floor(Math.random()*DB.length)].m; if(!opts.includes(r)) opts.push(r); }
            opts.sort(()=>Math.random()-0.5);
            dom.q.box.innerHTML='';
            opts.forEach(o=>{
                const b=document.createElement('div'); b.className='opt-btn'; b.innerText=o;
                b.onclick=()=>check(o,b); dom.q.box.appendChild(b);
            });
            speak('word');
        }

        function check(ans, btn) {
            if(ans===curQ.m) {
                btn.classList.add('correct'); STATE.ammo+=3; updateHUD(); 
                dom.q.sc.innerText=curQ.sc; dom.q.sc.style.display='block';
                speak('sent');
                setTimeout(()=>{ dom.quiz.style.display='none'; STATE.pause=false; },2000);
            } else {
                btn.classList.add('wrong'); speakText("Try again");
            }
        }

        function updateHUD() { dom.hud.hp.innerText=STATE.hp; dom.hud.lv.innerText=STATE.lv; dom.hud.key.innerText=STATE.key; dom.hud.ammo.innerText=STATE.ammo; }
        function speak(type) { window.speechSynthesis.cancel(); let txt=(type==='word')?curQ.w:curQ.s; const u=new SpeechSynthesisUtterance(txt); u.lang='en-US'; window.speechSynthesis.speak(u); }
        function speakText(t) { const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; window.speechSynthesis.speak(u); }

        window.onkeydown=e=>{if(e.key.includes('Arrow')) input[e.key[5].toLowerCase()]=true; if(e.key==' ') placeBomb();}
        window.onkeyup=e=>{if(e.key.includes('Arrow')) input[e.key[5].toLowerCase()]=false;}

        init();
    </script>
</body>
</html>
