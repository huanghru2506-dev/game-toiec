<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¥æ©˜è²“çˆ†ç ´ç‹ v6.0 (æœ€çµ‚å®Œç¾ç‰ˆ)</title>
    <style>
        /* --- æ ¸å¿ƒè¨­å®šï¼šé˜²èª¤è§¸ã€é–å®šç•«é¢ --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed; background: #222;
            touch-action: none; -webkit-user-select: none; user-select: none;
            font-family: 'Segoe UI', sans-serif; color: white;
            -webkit-tap-highlight-color: transparent;
        }

        #main-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }

        /* HUD */
        #hud { 
            width: 100%; max-width: 600px; padding: 8px 15px; background: #333; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid #555; font-weight: bold; font-size: 0.9rem;
            flex-shrink: 0; z-index: 50;
        }
        .ammo-box { color: #f1c40f; border: 1px solid #f1c40f; padding: 2px 8px; border-radius: 4px; }
        #reload-btn { 
            background: #0984e3; color: white; border: none; padding: 8px 15px; 
            border-radius: 4px; font-weight: bold; cursor: pointer; 
            animation: pulse-btn 2s infinite; font-size: 0.9rem;
        }
        @keyframes pulse-btn { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

        /* éŠæˆ²èˆå° */
        #stage { 
            position: relative; width: 90vmin; height: 90vmin; 
            max-width: 600px; max-height: 600px; 
            background: #555; border: 4px solid #000; overflow: hidden; margin: 5px 0;
        }
        .cell { position: absolute; width: 6.66%; height: 6.66%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        .wall { background: #333; border: 1px solid #222; box-shadow: inset 0 0 5px #000; }
        .brick { background: #e17055; border: 2px solid #d63031; transition: 0.2s; }
        .door { background: #000; border: 2px dashed #fff; } 
        .key { font-size: 1.5rem; animation: float 1s infinite alternate; }
        @keyframes float { from{transform:translateY(0)} to{transform:translateY(-5px)} }

        /* è§’è‰² (ä½¿ç”¨ Emoji) */
        #player { 
            position: absolute; width: 6.66%; height: 6.66%; z-index: 20; 
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; transition: top 0.1s linear, left 0.1s linear; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .enemy { position: absolute; width: 6.66%; height: 6.66%; z-index: 15; font-size: 1.5rem; text-align: center; transition: top 0.3s linear, left 0.3s linear; }
        .bomb { position: absolute; width: 5%; height: 5%; margin: 0.8%; z-index: 10; background: #2d3436; border-radius: 50%; border: 2px solid #fff; animation: tick 0.5s infinite alternate; }
        .fire { position: absolute; width: 6.66%; height: 6.66%; z-index: 12; background: rgba(255, 200, 0, 0.8); }
        @keyframes tick { from{transform:scale(0.9)} to{transform:scale(1.1)} }

        /* æ§åˆ¶å™¨ */
        #controls { 
            width: 100%; max-width: 500px; height: 160px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; flex-shrink: 0;
        }
        .dpad { position: relative; width: 140px; height: 140px; }
        .dbtn { 
            position: absolute; width: 50px; height: 50px; 
            background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4); 
            border-radius: 8px; 
        }
        .dbtn:active { background: rgba(255,255,255,0.5); }
        .du { top:0; left:45px; } .dd { bottom:0; left:45px; } 
        .dl { top:45px; left:0; } .dr { top:45px; right:0; }

        .act-btn { 
            width: 90px; height: 90px; border-radius: 50%; 
            background: #d63031; border: 4px solid #fab1a0; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 2.5rem; box-shadow: 0 5px 0 #8c1c1c; 
        }
        .act-btn:active { transform: translateY(5px); box-shadow: none; }

        /* ç­”é¡Œå¡ */
        #quiz-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; }
        .card { background: white; color: #333; width: 90%; max-width: 450px; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; text-align: center; position: relative; }
        .word { font-size: 2.2rem; color: #d63031; font-weight: 800; margin: 0; }
        .meta { color: #666; margin: 5px 0 15px 0; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-audio { border: 1px solid #ccc; background: #eee; border-radius: 15px; padding: 4px 12px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        
        /* å­¸ç¿’å€æ¨£å¼ */
        .sent-box { background: #f1f2f6; padding: 15px; border-radius: 8px; text-align: left; margin-bottom: 15px; border-left: 5px solid #0984e3; display: none; }
        .sent-row { margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .sent-row:last-child { border-bottom: none; }
        .en-text { font-weight: bold; font-size: 1.05rem; color: #2d3436; }
        .cn-text { color: #636e72; font-size: 0.9rem; margin-top: 2px; }
        
        .opt-btn { width: 100%; padding: 15px; margin: 6px 0; border: 1px solid #ccc; background: #fff; border-radius: 8px; font-size: 1.1rem; text-align: left; font-weight: bold; cursor: pointer; }
        .opt-btn.correct { background: #00b894; color: white; border-color: #00b894; }
        .opt-btn.wrong { background: #d63031; color: white; border-color: #d63031; }
        
        /* æ‰‹å‹•é—œé–‰æŒ‰éˆ• */
        #close-quiz-btn {
            display: none; width: 100%; padding: 15px; margin-top: 15px;
            background: #0984e3; color: white; border: none; border-radius: 8px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #0762a8;
        }
        #close-quiz-btn:active { transform: translateY(4px); box-shadow: none; }
    </style>
</head>
<body>

    <div id="main-wrapper">
        <div id="hud">
            <span>â¤ï¸<span id="ui-hp">3</span></span>
            <span>Lv.<span id="ui-lv">1</span></span>
            <span>ğŸ”‘<span id="ui-key">0</span></span>
            <span class="ammo-box">ğŸ’£<span id="ui-ammo">5</span></span>
            <button id="reload-btn" onclick="triggerQuiz()">+ è£œçµ¦(å­¸ç¿’)</button>
        </div>

        <div id="stage">
            <div id="layer-grid"></div>
            <div id="layer-item"></div>
            <div id="layer-obj"></div>
            <div id="layer-ent"></div>
            <div id="player">ğŸ±</div>
        </div>

        <div id="controls">
            <div class="dpad">
                <div class="dbtn du" ontouchstart="input.u=true; event.preventDefault()" ontouchend="input.u=false"></div>
                <div class="dbtn dd" ontouchstart="input.d=true; event.preventDefault()" ontouchend="input.d=false"></div>
                <div class="dbtn dl" ontouchstart="input.l=true; event.preventDefault()" ontouchend="input.l=false"></div>
                <div class="dbtn dr" ontouchstart="input.r=true; event.preventDefault()" ontouchend="input.r=false"></div>
            </div>
            <div class="act-btn" ontouchstart="placeBomb(); event.preventDefault()">ğŸ’£</div>
        </div>
    </div>

    <div id="quiz-layer">
        <div class="card">
            <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">TOEIC è¨˜æ†¶ç‰¹è¨“</div>
            <h1 class="word" id="q-w">Word</h1>
            <div class="meta">
                <span id="q-p">/pho/</span> <span id="q-t">n.</span>
                <button class="btn-audio" onclick="speak('word')">ğŸ”Š å–®å­—</button>
            </div>
            
            <div id="opt-box"></div>

            <div id="learn-area" class="sent-box">
                <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">â˜… å¿…è€ƒæ­é…è© (Collocations)</div>
                <div id="sent-content"></div>
                <button class="btn-audio" style="width:100%; margin-top:10px; justify-content: center;" onclick="speak('sent')">ğŸ”Š æ’­æ”¾æ•´çµ„ä¾‹å¥å¹«åŠ©è¨˜æ†¶</button>
            </div>

            <button id="close-quiz-btn" onclick="closeQuiz()">âœ… æˆ‘è¨˜ä½äº†ï¼Œç¹¼çºŒéŠæˆ²</button>
        </div>
    </div>

    <script>
        // é˜²èª¤è§¸è¨­å®š
        document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('dblclick', e => e.preventDefault());

        // ==========================================
        // 1. ä¸‰å¥å¼è³‡æ–™åº« (æ ¼å¼ï¼šå–®å­—|éŸ³æ¨™|è©æ€§|ä¸­æ–‡|è‹±1^ä¸­1^è‹±2^ä¸­2^è‹±3^ä¸­3)
        // ==========================================
        const RAW_DATA = [
            "Agenda|/É™ËˆdÊ’en.dÉ™/|n.|è­°ç¨‹|The agenda is set.^è­°ç¨‹å·²è¨­å®šã€‚^item on the agenda^è­°ç¨‹ä¸Šçš„é …ç›®^copy of the agenda^è­°ç¨‹çš„å‰¯æœ¬",
            "Budget|/ËˆbÊŒdÊ’.Éªt/|n.|é ç®—|within budget^åœ¨é ç®—å…§^tight budget^é ç®—åƒç·Š^budget cut^é ç®—åˆªæ¸›",
            "Colleague|/ËˆkÉ‘Ë.liËÉ¡/|n.|åŒäº‹|senior colleague^è³‡æ·±åŒäº‹^trusted colleague^å€¼å¾—ä¿¡è³´çš„åŒäº‹^meet a colleague^è¦‹ä¸€ä½åŒäº‹",
            "Deadline|/Ëˆded.laÉªn/|n.|æˆªæ­¢æœŸé™|meet the deadline^è¶•ä¸Šæˆªæ­¢æœŸé™^miss the deadline^éŒ¯éæˆªæ­¢æœŸé™^tight deadline^ç·Šè¿«çš„æœŸé™",
            "Executive|/ÉªÉ¡Ëˆzek.jÉ™.tÉªv/|n.|é«˜éšä¸»ç®¡|chief executive^åŸ·è¡Œé•·^senior executive^è³‡æ·±ä¸»ç®¡^executive decision^æ±ºç­–",
            "Feedback|/ËˆfiËd.bÃ¦k/|n.|å›é¥‹|give feedback^çµ¦äºˆå›é¥‹^positive feedback^æ­£é¢çš„å›é¥‹^customer feedback^å®¢æˆ¶å›é¥‹",
            "Guarantee|/ËŒÉ¡Ã¦r.É™nËˆtiË/|v.|ä¿è­‰|satisfaction guaranteed^ä¿è­‰æ»¿æ„^money-back guarantee^é€€æ¬¾ä¿è­‰^under guarantee^åœ¨ä¿å›ºæœŸå…§",
            "Implement|/ËˆÉªm.plÉ™.ment/|v.|å¯¦æ–½|implement a plan^å¯¦æ–½è¨ˆç•«^implement changes^å¯¦æ–½è®Šæ›´^fully implemented^å®Œå…¨å¯¦æ–½",
            "Lucrative|/ËˆluË.krÉ™.tÉªv/|adj.|è³ºéŒ¢çš„|lucrative business^è³ºéŒ¢çš„ç”Ÿæ„^lucrative contract^åˆ©æ½¤è±åšçš„åˆç´„^highly lucrative^éå¸¸è³ºéŒ¢",
            "Merger|/ËˆmÉË.dÊ’Éš/|n.|åˆä½µ|merger and acquisition^åˆä½µèˆ‡æ”¶è³¼^proposed merger^æè­°çš„åˆä½µ^merger talks^åˆä½µè«‡åˆ¤",
            "Negotiate|/nÉ™ËˆÉ¡oÊŠ.Êƒi.eÉªt/|v.|è«‡åˆ¤|negotiate a price^è«‡åˆ¤åƒ¹æ ¼^negotiate a contract^è«‡åˆ¤åˆç´„^negotiate terms^è«‡åˆ¤æ¢æ¬¾",
            "Recruit|/rÉªËˆkruËt/|v.|æ‹›å‹Ÿ|recruit new staff^æ‹›å‹Ÿæ–°å“¡å·¥^recruit talent^æ‹›å‹Ÿäººæ‰^actively recruit^ç©æ¥µæ‹›å‹Ÿ",
            "Resume|/rÉªËˆzuËm/|n.|å±¥æ­·è¡¨|submit a resume^æäº¤å±¥æ­·^send a resume^å¯„é€å±¥æ­·^resume and cover letter^å±¥æ­·èˆ‡æ±‚è·ä¿¡",
            "Penalty|/Ëˆpen.É™l.ti/|n.|ç½°æ¬¾|pay a penalty^æ”¯ä»˜ç½°æ¬¾^face a penalty^é¢è‡¨ç½°æ¬¾^death penalty^æ­»åˆ‘",
            "Itinerary|/laÉªËˆÉ™.bÉ™l/|n.|è¡Œç¨‹è¡¨|travel itinerary^æ—…éŠè¡Œç¨‹^detailed itinerary^è©³ç´°è¡Œç¨‹^plan an itinerary^è¦åŠƒè¡Œç¨‹",
            "Asset|/ËˆÃ¦s.et/|n.|è³‡ç”¢|valuable asset^å¯¶è²´è³‡ç”¢^company asset^å…¬å¸è³‡ç”¢^liquid asset^æµå‹•è³‡ç”¢",
            "Deficit|/Ëˆdef.É™.sÉªt/|n.|èµ¤å­—|budget deficit^é ç®—èµ¤å­—^trade deficit^è²¿æ˜“èµ¤å­—^reduce the deficit^æ¸›å°‘èµ¤å­—",
            "Portfolio|/ËŒpÉ”ËrtËˆfoÊŠ.li.oÊŠ/|n.|ä½œå“é›†/æŠ•è³‡çµ„åˆ|investment portfolio^æŠ•è³‡çµ„åˆ^design portfolio^è¨­è¨ˆä½œå“é›†^diverse portfolio^å¤šæ¨£åŒ–çš„çµ„åˆ",
            "Refund|/ËˆriË.fÊŒnd/|n.|é€€æ¬¾|full refund^å…¨é¡é€€æ¬¾^demand a refund^è¦æ±‚é€€æ¬¾^non-refundable^ä¸å¯é€€æ¬¾çš„",
            "Valid|/ËˆvÃ¦l.Éªd/|adj.|æœ‰æ•ˆçš„|valid passport^æœ‰æ•ˆè­·ç…§^valid reason^æ­£ç•¶ç†ç”±^remain valid^ä¿æŒæœ‰æ•ˆ",
            "Acquire|/É™ËˆkwaÉªÉš/|v.|æ”¶è³¼/ç²å¾—|acquire a company^æ”¶è³¼å…¬å¸^acquire skills^ç²å¾—æŠ€èƒ½^acquire knowledge^ç²å–çŸ¥è­˜",
            "Bankruptcy|/ËˆbÃ¦Å‹.krÊŒpt.si/|n.|ç ´ç”¢|file for bankruptcy^ç”³è«‹ç ´ç”¢^face bankruptcy^é¢è‡¨ç ´ç”¢^declare bankruptcy^å®£å‘Šç ´ç”¢",
            "Capacity|/kÉ™ËˆpÃ¦s.É™.tÌ¬i/|n.|å®¹é‡/èƒ½åŠ›|full capacity^ç”¢èƒ½æ»¿è¼‰^seating capacity^åº§ä½å®¹é‡^storage capacity^å„²å­˜å®¹é‡",
            "Collaborate|/kÉ™ËˆlÃ¦b.É™.reÉªt/|v.|åˆä½œ|collaborate with^èˆ‡...åˆä½œ^collaborate on^åœ¨...ä¸Šåˆä½œ^close collaboration^å¯†åˆ‡åˆä½œ",
            "Designate|/Ëˆdez.ÉªÉ¡.neÉªt/|v.|æŒ‡å®š|designated area^æŒ‡å®šå€åŸŸ^designated driver^æŒ‡å®šé§•é§›^designated smoking area^æŒ‡å®šå¸è¸å€",
            "Fluctuate|/ËˆflÊŒk.tÊƒu.eÉªt/|v.|æ³¢å‹•|prices fluctuate^åƒ¹æ ¼æ³¢å‹•^fluctuate wildly^åŠ‡çƒˆæ³¢å‹•^market fluctuations^å¸‚å ´æ³¢å‹•",
            "Mandatory|/ËˆmÃ¦n.dÉ™.tÉ”Ë.ri/|adj.|å¼·åˆ¶çš„|mandatory training^å¼·åˆ¶è¨“ç·´^mandatory retirement^å¼·åˆ¶é€€ä¼‘^it is mandatory^é€™æ˜¯å¼·åˆ¶çš„",
            "Launch|/lÉ‘ËntÊƒ/|v.|ç™¼å¸ƒ/ä¸Šå¸‚|launch a product^ç™¼å¸ƒç”¢å“^launch a campaign^ç™¼èµ·æ´»å‹•^official launch^æ­£å¼ç™¼å¸ƒ",
            "Nominate|/ËˆnÉ‘Ë.mÉ™.neÉªt/|v.|æå|nominate a candidate^æåå€™é¸äºº^nominate for an award^æåçé …^be nominated^è¢«æå",
            "Renovate|/Ëˆren.É™.veÉªt/|v.|æ•´ä¿®|renovate the office^æ•´ä¿®è¾¦å…¬å®¤^newly renovated^æ–°è£ä¿®çš„^closed for renovation^é—œé–‰æ•´ä¿®ä¸­"
        ];

        // è³‡æ–™è§£æ
        const DB = RAW_DATA.map(line => {
            const p = line.split('|');
            const sents = p[4].split('^');
            let formattedSents = [];
            for(let i=0; i<sents.length; i+=2) {
                if(sents[i+1]) formattedSents.push({ en: sents[i], cn: sents[i+1] });
            }
            return { w: p[0], pho: p[1], t: p[2], m: p[3], sentences: formattedSents };
        });

        // éŠæˆ²æ ¸å¿ƒ
        const GRID = 15, TILE = 6.666;
        const STATE = { lv:1, hp:3, key:0, pause:false, bombs:1, range:2, ammo:5 }; 
        let map=[], enemies=[], bombs=[], player={gx:1,gy:1,el:null}, curQ=null;
        const input = {u:false,d:false,l:false,r:false};

        const dom = {
            grid: document.getElementById('layer-grid'),
            item: document.getElementById('layer-item'),
            obj: document.getElementById('layer-obj'),
            ent: document.getElementById('layer-ent'),
            player: document.getElementById('player'),
            quiz: document.getElementById('quiz-layer'),
            hud: { hp: document.getElementById('ui-hp'), lv: document.getElementById('ui-lv'), key: document.getElementById('ui-key'), ammo: document.getElementById('ui-ammo') },
            q: { w: document.getElementById('q-w'), p: document.getElementById('q-p'), t: document.getElementById('q-t'), box: document.getElementById('opt-box') },
            learn: document.getElementById('learn-area'),
            learnContent: document.getElementById('sent-content'),
            closeBtn: document.getElementById('close-quiz-btn')
        };

        function init() {
            startLevel(1);
            loop();
        }

        function startLevel(lv) {
            STATE.lv = lv; STATE.key = 0; STATE.pause = false;
            STATE.range = 2 + Math.floor(lv/3);
            
            dom.grid.innerHTML=''; dom.item.innerHTML=''; dom.obj.innerHTML=''; dom.ent.innerHTML='';
            bombs=[]; enemies=[]; map=[];

            for(let y=0; y<GRID; y++) {
                let row = [];
                for(let x=0; x<GRID; x++) {
                    const el=document.createElement('div'); el.className='cell';
                    el.style.left=(x*TILE)+'%'; el.style.top=(y*TILE)+'%'; el.id=`c-${x}-${y}`;
                    if(x===0||x===GRID-1||y===0||y===GRID-1||(x%2===0&&y%2===0)) { row.push(1); el.classList.add('wall'); }
                    else if(x<3&&y<3) { row.push(0); }
                    else { if(Math.random()<0.3) { row.push(2); el.classList.add('brick'); } else row.push(0); }
                    dom.grid.appendChild(el);
                }
                map.push(row);
            }

            let bricks=[]; for(let y=0; y<GRID; y++) for(let x=0; x<GRID; x++) if(map[y][x]===2) bricks.push({x,y});
            if(bricks.length>2) {
                let k=bricks.splice(Math.floor(Math.random()*bricks.length),1)[0]; map[k.y][k.x]=-4;
                let d=bricks.splice(Math.floor(Math.random()*bricks.length),1)[0]; map[d.y][d.x]=-3;
            }

            const count=2+Math.floor(lv/2);
            for(let i=0; i<count; i++) {
                let x,y; do{x=Math.floor(Math.random()*GRID); y=Math.floor(Math.random()*GRID);} while(map[y][x]!==0 || (x<5&&y<5));
                const el=document.createElement('div'); el.className='enemy'; el.innerText=['ğŸ¦ ','ğŸ‘¿','ğŸ‘»'][i%3];
                dom.ent.appendChild(el);
                enemies.push({x,y,el,timer:0,speed:Math.max(10,40-lv*2)});
            }
            updateHUD(); player.gx=1; player.gy=1; updatePlayer();
        }

        function loop() {
            if(!STATE.pause) { movePlayer(); moveEnemies(); updateBombs(); }
            requestAnimationFrame(loop);
        }

        let cd=0;
        function movePlayer() {
            if(cd>0) {cd--; return;}
            let dx=0,dy=0;
            if(input.u) dy=-1; else if(input.d) dy=1; else if(input.l) dx=-1; else if(input.r) dx=1;
            if(dx||dy) {
                let nx=player.gx+dx, ny=player.gy+dy;
                if(nx<0||nx>=GRID||ny<0||ny>=GRID) return;
                let cell=map[ny][nx];
                let bomb=bombs.find(b=>b.x===nx && b.y===ny && !b.pass);
                if((cell<=0||cell===3||cell===4) && !bomb) {
                    player.gx=nx; player.gy=ny; updatePlayer(); checkItem(); cd=4; // é€Ÿåº¦
                    bombs.forEach(b=>{if(b.x!==player.gx||b.y!==player.gy) b.pass=false;});
                }
            }
        }
        function updatePlayer() { dom.player.style.left=(player.gx*TILE)+'%'; dom.player.style.top=(player.gy*TILE)+'%'; }

        function moveEnemies() {
            enemies.forEach(e=>{
                if(e.x===player.gx && e.y===player.gy) hitPlayer();
                if(e.timer>0) {e.timer--; return;}
                e.timer=e.speed;
                const dirs=[[0,1],[0,-1],[1,0],[-1,0]];
                let moved=false, tries=0;
                while(!moved && tries<4) {
                    let d=dirs[Math.floor(Math.random()*4)];
                    let nx=e.x+d[0], ny=e.y+d[1];
                    if(nx>=0&&nx<GRID&&ny>=0&&ny<GRID) {
                        if(map[ny][nx]<=0 && !bombs.find(b=>b.x===nx&&b.y===ny)) {
                            e.x=nx; e.y=ny; e.el.style.left=(e.x*TILE)+'%'; e.el.style.top=(e.y*TILE)+'%'; moved=true;
                        }
                    }
                    tries++;
                }
                if(e.x===player.gx && e.y===player.gy) hitPlayer();
            });
        }
        function hitPlayer() { STATE.hp--; updateHUD(); if(STATE.hp<=0) { alert('Game Over!'); startLevel(STATE.lv); STATE.hp=3; updateHUD(); } }

        function checkItem() {
            let c=map[player.gy][player.gx];
            if(c===4) { STATE.key=1; map[player.gy][player.gx]=0; document.getElementById(`item-${player.gx}-${player.gy}`).remove(); updateHUD(); }
            else if(c===3 && STATE.key) { alert('Level Up!'); startLevel(STATE.lv+1); }
        }

        function placeBomb() {
            if(STATE.pause) return;
            if(STATE.ammo<=0) { let b=document.getElementById('reload-btn'); b.style.background='red'; setTimeout(()=>b.style.background='#0984e3',200); return; }
            if(bombs.find(b=>b.x===player.gx && b.y===player.gy)) return;
            STATE.ammo--; updateHUD();
            const el=document.createElement('div'); el.className='bomb';
            el.style.left=(player.gx*TILE)+'%'; el.style.top=(player.gy*TILE)+'%';
            dom.obj.appendChild(el);
            bombs.push({x:player.gx, y:player.gy, el:el, tick:180, pass:true});
        }

        function updateBombs() {
            for(let i=bombs.length-1; i>=0; i--) {
                let b=bombs[i]; if(!STATE.pause) b.tick--;
                if(b.tick<=0) { explode(b); bombs.splice(i,1); }
            }
        }

        function explode(b) {
            b.el.remove();
            let hits=[{x:b.x, y:b.y}];
            [[0,1],[0,-1],[1,0],[-1,0]].forEach(d=>{
                for(let i=1; i<=STATE.range; i++) {
                    let nx=b.x+d[0]*i, ny=b.y+d[1]*i;
                    if(nx<0||nx>=GRID||ny<0||ny>=GRID) break;
                    if(map[ny][nx]===1) break;
                    hits.push({x:nx, y:ny});
                    if(map[ny][nx]===2 || map[ny][nx]<0) { breakBrick(nx,ny); break; }
                }
            });
            hits.forEach(h=>{
                const f=document.createElement('div'); f.className='fire';
                f.style.left=(h.x*TILE)+'%'; f.style.top=(h.y*TILE)+'%';
                dom.obj.appendChild(f); setTimeout(()=>f.remove(), 500);
                if(player.gx===h.x && player.gy===h.y) hitPlayer();
                for(let i=enemies.length-1; i>=0; i--) { if(enemies[i].x===h.x && enemies[i].y===h.y) { enemies[i].el.remove(); enemies.splice(i,1); }}
            });
        }

        function breakBrick(x,y) {
            const el=document.getElementById(`c-${x}-${y}`); el.className='cell';
            if(map[y][x]===-4) { map[y][x]=4; const i=document.createElement('div'); i.className='cell key'; i.innerText='ğŸ”‘'; i.id=`item-${x}-${y}`; i.style.left=(x*TILE)+'%'; i.style.top=(y*TILE)+'%'; dom.item.appendChild(i); }
            else if(map[y][x]===-3) { map[y][x]=3; el.classList.add('door'); el.innerText='ğŸšª'; }
            else map[y][x]=0;
        }

        function triggerQuiz() {
            STATE.pause=true; dom.quiz.style.display='flex';
            dom.learn.style.display='none'; dom.closeBtn.style.display='none'; dom.q.box.style.display='grid';
            
            const q = DB[Math.floor(Math.random()*DB.length)]; curQ=q;
            dom.q.w.innerText=q.w; dom.q.p.innerText=q.pho; dom.q.t.innerText=q.t;
            
            let opts=[q.m]; while(opts.length<4) { let r=DB[Math.floor(Math.random()*DB.length)].m; if(!opts.includes(r)) opts.push(r); }
            opts.sort(()=>Math.random()-0.5);
            
            dom.q.box.innerHTML='';
            opts.forEach(o=>{
                const b=document.createElement('div'); b.className='opt-btn'; b.innerText=o;
                b.onclick=()=>check(o,b); dom.q.box.appendChild(b);
            });
            speak('word');
        }

        function check(ans, btn) {
            if(ans===curQ.m) {
                btn.classList.add('correct');
                
                // â˜… é€™è£¡ç§»é™¤äº† setTimeoutï¼Œæ”¹ç‚ºé¡¯ç¤ºæ‰‹å‹•é—œé–‰æŒ‰éˆ• â˜…
                dom.q.box.style.display='none';
                dom.learn.style.display='block';
                dom.closeBtn.style.display='block';
                
                let html = '';
                curQ.sentences.forEach(s => {
                    html += `<div class="sent-row"><div class="en-text">${s.en}</div><div class="cn-text">${s.cn}</div></div>`;
                });
                dom.learnContent.innerHTML = html;
                
                speak('sent');
            } else {
                btn.classList.add('wrong'); speakText("Try again");
            }
        }

        function closeQuiz() {
            STATE.ammo += 5; updateHUD(); // ç­”å°çå‹µ
            dom.quiz.style.display='none'; STATE.pause=false;
        }

        function updateHUD() { dom.hud.hp.innerText=STATE.hp; dom.hud.lv.innerText=STATE.lv; dom.hud.key.innerText=STATE.key; dom.hud.ammo.innerText=STATE.ammo; }
        
        function speak(type) {
            window.speechSynthesis.cancel();
            let txt = "";
            if(type==='word') txt = curQ.w;
            else if(type==='sent') curQ.sentences.forEach(s => txt += s.en + ". ");
            const u=new SpeechSynthesisUtterance(txt); u.lang='en-US'; window.speechSynthesis.speak(u);
        }
        function speakText(t) { const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; window.speechSynthesis.speak(u); }

        window.onkeydown=e=>{if(e.key.includes('Arrow')) input[e.key[5].toLowerCase()]=true; if(e.key==' ') placeBomb();}
        window.onkeyup=e=>{if(e.key.includes('Arrow')) input[e.key[5].toLowerCase()]=false;}

        init();
    </script>
</body>
</html>
